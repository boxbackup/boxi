<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html;charset=iso-8859-1" />
<title>Fixing problems with corruption on the server</title>
<link rel="stylesheet" href="bbstyles.css" type="text/css" />
</head>
<body>
<div align="center">
<div id="header">
<div id="logo">
<img src="images/bblogo.png" alt="logo" height="65" width="331" border="0" vspace="5" align="middle" /> <img src="images/stepahead.png" alt="a step ahead in data security" width="182" height="11" hspace="10" vspace="20" border="0" align="middle" /></div>
</div>
<div id="page">

<h1>Fixing problems with corruption on the server</h1>

<p>This page gives help on what to do if your server has suffered corruption, for example,
after an unclean shutdown or other OS or hardware problem.</p>

<p>In general, as updates to the store are made in an atomic manner, the most
likely result is wasted disc space. However, if really bad things happen, or you believe that
there is a lot of wasted space, then these instructions will help to restore your data.</p>

<p>You know you will need to do something if you get strange errors, and <tt>bbackupd</tt> attempts
to contact the server every 100 seconds or so. Or if one of the discs in your RAID disc set has failed.</p>

<p>After following these instructions, the end result will be that <tt>bbackupquery</tt> will be able to see all the files which
were stored on your server, and retrieve them. Some of them may be in <tt>lost+found</tt>
directories in the root of the store (or in their original position if they have been moved) but they will all
be able to be retrieved.</p>

<p>After you have retrieved the files you want, <tt>bbackupd</tt> will upload new versions
where necessary, and after about two days, mark any <tt>lost+found</tt> directories as deleted.
Finally, those directories will be removed by the housekeeping process on the server.</p>

<p>These instructions assume you're working on account 1234, subsitute this for whatever account
you're actually working on. These will need to be repeated for all affected accounts.</p>

<h2>1. Stop bbackupd</h2>

<p>First, make sure that <tt>bbackupd</tt> is not running on the client machine for the account
you are going to recover. Use <tt>kill</tt> to terminate it.</p>

<p>(This step is not strictly necessary, but is recommended. During any checks on the account,
<tt>bbackupd</tt> will be unable to log in, and after they are complete, the account is marked
as changed on the server so <tt>bbackupd</tt> will perform a complete scan.)</p>

<h2>2. Are you using RAID on the server?</h2>

<p>At the moment, the raidfile recovery tools have not been written. However, when two out of
three files are available, the server will run succesfully, even if it complains a lot in the logs.
So, your best bet here is to fix the accounts, if necessary, and retrieve any files you need. Then move
the old store directories aside (in case you need them) and start afresh with new accounts, and 
let the clients upload all their data again.</p>

<p>These utilities will be written shortly!</p>

<h2>3. Check and fix the account</h2>

<p>First, run the check utility, and see what errors it reports.</p>

<pre>
  /usr/local/bin/bbstoreaccounts check 1234
</pre>

<p>This will take some time, and use a fair bit of memory (about 16 bytes per file and directory).
If the output looks plausible and reports errors which need fixing, run it again but with the
<tt>fix</tt> flag:</p>

<pre>
  /usr/local/bin/bbstoreaccounts check 1234 fix
</pre>

<p>This will fix any errors, and remove unrecoverable files. Directories will be recreated if necessary.</p>

<p><b>NOTE</b>: The utility may adjust the soft and hard limits on the account to make sure that
housekeeping will not remove anything -- check these afterwards.</p>

<h2>4. Grab any files you need with bbackupquery</h2>

<p>At this point, you will have a working store. Every file which was on the server, and wasn't corrupt,
will be available.<p>

<p>On the client, use <tt>bbackupquery</tt> to log in and examine the store. (type <tt>help</tt> at the
prompt for instructions). Retrieve any files you need, paying attention to any <tt>lost+found</tt>
directories in the root directory of the store.</p>

<p>You can skip this step if you are sure that the client machine is fine -- in this case, <tt>bbackupd</tt>
will bring the store up to date.</p>

<h2>5. Restart bbackupd</h2>

<p>Restart <tt>bbackupd</tt> on the client machine. The store account will be brought up to date, and
files in the wrong place will be marked for eventual deletion.</p>


<p>&nbsp;</p>
<p>&copy; Ben Summers, 2003, 2004</p>
<p>&nbsp;</p>
</div>
</div>
</body>
</html>
