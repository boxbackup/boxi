<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html;charset=iso-8859-1" />
<title>Box Backup certificates and accounts</title>
<link rel="stylesheet" href="bbstyles.css" type="text/css" />
</head>
<body>
<div align="center">
<div id="header">
<div id="logo">
<img src="images/bblogo.png" alt="logo" height="65" width="331" border="0" vspace="5" align="middle" /> <img src="images/stepahead.png" alt="a step ahead in data security" width="182" height="11" hspace="10" vspace="20" border="0" align="middle" /></div>
</div>
<div id="page">


<h1>Box Backup certificates and accounts</h1>

<p>There are two steps involved to create an account. You need to create the account on the
server, and sign a certificate to give the client permission to connect to the server.</p>

<p>Running a Certification Authority for TLS (SSL) connections is not trivial. However,
I have written a script to do most of the work in a way which is good enough for most
deployments.</p>

<h2>Warning about clock times</h2>

<p>SSL certificates contain validity dates, including a "valid from" time. If the clock on the
machine which signs the certificates is not syncronised to the clocks of the machines using these
certificates, you will probably get strange errors until the start time is reached on all
machines.</p>

<p>If you get strange errors when attempting to use new certificates, check the clocks! You will
probably just need to wait a while until the certificates become valid, rather than having to
regenerate them.</p>

<h2>Set up CA</h2>

<p>It's best to do this on a machine other than your server, probably without direct network access.
The contents of this directory control who can access your backup store server.</p>

<p>To setup the basic key structure, do</p>

<pre>
/usr/local/bin/bbstored-certs ca init
</pre>

<p>(See <a href="openssl.html">OpenSSL notes</a> if you get an OpenSSL error)</p>

<p>This creates the directory 'ca' in the current directory, and initialises it with basic keys.</p>

<h2>Sign a server certificate</h2>

<p>When you use the <tt>bbstored-config</tt> script to set up a config file for a server, it will
generate a certificate request (CSR) for you. Transfer it to the machine with your CA, then do</p>

<pre>
/usr/local/bin/bbstored-certs ca sign-server hostname-csr.pem
</pre>

<p>which signs the certificate for the server. Follow the instructions in the output on which files to install
on the server. The CSR file is now no longer needed. Make sure you run this command from the directory above
the directory 'ca'.</p>

<h2>Setting up an account.</h2>

<p>Choose an account number for the user. This must be unique on the server, and is presented as a 31 bit
number in hex greater than 0, for example, 1 or 75AB23C. Then on the backup store server, create the account
with</p>

<pre>
/usr/local/bin/bbstoreaccounts create 75AB23C 0 4096M 4505M
</pre>

<p>This looks complicated. The numbers are, in order...</p>
<ul>
<li>The account number allocated (hex)
<li>The RAID disc set (0 if you use raidfile-config and don't add a new set)
<li>Soft limit (size)
<li>Hard limit (size)
</ul>

<p>The sizes are are specified in Mb, Gb, or blocks, depending on the suffix. <tt>1M</tt> specifies 1 Mb,
<tt>1G</tt> specifies 1 Gb, and <tt>1B</tt> specifies 1 block, the size of which depends on how you have
configured the raidfile system with <tt>raidfile-config</tt>.</p>

<p>In this example, I have allocated 4Gb (assuming you use 2048 byte blocks as per my example) as the soft limit,
and 4Gb + 10% as the hard limit.</p>

<p><b>NOTE</b> The sizes specified here are pre-RAID. So if you are using userland RAID, you are
actually allocating two-thirds of this amount. This means that, when you take compression into account, that
if you allocate 2Gb on the server, it'll probably hold about 2Gb of backed up files (depending on the 
compressability of those files).</p>

<p>The backup client will (voluntarily) try not to upload more data than is allowed by the soft limit.
The store server will refuse to accept a file if it would take it over the hard limit, and when doing
housekeeping for this account, try and delete old versions and deleted files to reduce the space taken
to below the soft limit.</p>

<p>This command will create some files on disc in the raid file directories (if you run as root, the utility will
change to the user specified in the bbstored.conf file to write them) and update the accounts file. A server
restart is not required.</p>

<p><b>NOTE</b> If you get a message saying '<tt>Exception: RaidFile (2/8)</tt>', the directories you specified
in the raidfile.conf are not writable by the _bbstored user -- fix it, and try again.</p>

<p>Finally, tell the user their account number, and the hostname of your server. They will use this to
set up the backup client, and send you a CSR. This has the account number embedded in it, and you should
be sure that it has the right account number in it.</p>

<p>Sign this CSR with</p>

<pre>
/usr/local/bin/bbstored-certs ca sign 75AB23C-csr.pem
</pre>

<p>Don't forget to check that the embedded account number is correct! Then send the two files back to the user,
as instructed by the script.</p>

<p>Please read the <a href="trouble.html">Troubleshooting</a> page if you have problems.</p>


<h2>Finding disc space used, and changing limits.</h2>

<p>To display the space used on the server for an account, use</p>

<pre>
  /usr/local/bin/bbstoreaccounts info 75AB23C
</pre>

<p>To adjust the soft and hard limits on an account, use</p>

<pre>
  /usr/local/bin/bbstoreaccounts setlimit 75AB23C new-soft-limit new-hard-limit
</pre>

<p>You do not need to restart the server if the limits are changed.</p>


<h2>Deleting an account</h2>

<p>To remove an account, deleting all the stored files on the server and removing
the account information which allows a client to log in, use</p>

<pre>
  /usr/local/bin/bbstoreaccounts delete 75AB23C
</pre>

<p>This will ask for confirmation. Append <tt>yes</tt> to the command to delete
without confirmation.</p>


<h2>Verifying a store account</h2>

<p>To check that a store account is not corrupt, and optionally fix any errors,
use</p>

<pre>
  /usr/local/bin/bbstoreaccounts check 75AB23C
  /usr/local/bin/bbstoreaccounts check 75AB23C fix
</pre>

<p>The second command will fix errors it finds, the first will merely report them.</p>

<p>Append <tt>quiet</tt> to reduce the amount of output, although errors are always reported.</p>

<p>See <a href="serverfix.html">fixing problems with corruption on the server</a> for more information.</p>


<p>&nbsp;</p>
<p>&copy; Ben Summers, 2003, 2004</p>
<p>&nbsp;</p>
</div>
</div>
</body>
</html>


